#include <config.h>
#include <render.h>
#include <stdlib.h>
#include <string.h>

static T_Layout g_atSettingPageIconsLayout[] = {
    {0, 0, 0, 0, "select_fold.bmp"},
    {0, 0, 0, 0, "interval.bmp"},
    {0, 0, 0, 0, "return.bmp"},
    {0, 0, 0, 0, NULL},
};

static T_PageLayout g_tSettingPageLayout = {
    .iMaxTotalBytes = 0,
    .atLayout       = g_atSettingPageIconsLayout,
};


/**********************************************************************
 * 函数名称： CalcSettingPageLayout
 * 功能描述： 计算页面中各图标座标值
 * 输入参数： 无
 * 输出参数： ptPageLayout - 内含各图标的左上角/右下角座标值
 * 返 回 值： 无
 * 修改日期        版本号     修改人          修改内容
 * -----------------------------------------------
 * 2013/02/08         V1.0      韦东山          创建
 ***********************************************************************/
static void  CalcSettingPageLayout(PT_PageLayout ptPageLayout)
{
    int iStartY;
    int iWidth;
    int iHeight;
    int iXres, iYres, iBpp;
    int iTmpTotalBytes;
    PT_Layout atLayout;

    atLayout = ptPageLayout->atLayout;
    GetDispResolution(&iXres, &iYres, &iBpp);
    ptPageLayout->iBpp = iBpp;

    /*   
     *    ----------------------
     *                           1/2 * iHeight
     *          select_fold.bmp  iHeight
     *                           1/2 * iHeight
     *          interval.bmp     iHeight
     *                           1/2 * iHeight
     *          return.bmp       iHeight
     *                           1/2 * iHeight
     *    ----------------------
     */
     
    iHeight = iYres * 2 / 10;
    iWidth  = iHeight;
    iStartY = iHeight / 2;
    
    /* select_fold图标 */
    atLayout[0].iTopLeftY  = iStartY;
    atLayout[0].iBotRightY = atLayout[0].iTopLeftY + iHeight - 1;
    atLayout[0].iTopLeftX  = (iXres - iWidth * 2) / 2;
    atLayout[0].iBotRightX = atLayout[0].iTopLeftX + iWidth * 2 - 1;

    iTmpTotalBytes = (atLayout[0].iBotRightX - atLayout[0].iTopLeftX + 1) * (atLayout[0].iBotRightY - atLayout[0].iTopLeftY + 1) * iBpp / 8;
    if (ptPageLayout->iMaxTotalBytes < iTmpTotalBytes)
    {
        ptPageLayout->iMaxTotalBytes = iTmpTotalBytes;
    }


    /* interval图标 */
    atLayout[1].iTopLeftY  = atLayout[0].iBotRightY + iHeight / 2 + 1;
    atLayout[1].iBotRightY = atLayout[1].iTopLeftY + iHeight - 1;
    atLayout[1].iTopLeftX  = (iXres - iWidth * 2) / 2;
    atLayout[1].iBotRightX = atLayout[1].iTopLeftX + iWidth * 2 - 1;

    iTmpTotalBytes = (atLayout[1].iBotRightX - atLayout[1].iTopLeftX + 1) * (atLayout[1].iBotRightY - atLayout[1].iTopLeftY + 1) * iBpp / 8;
    if (ptPageLayout->iMaxTotalBytes < iTmpTotalBytes)
    {
        ptPageLayout->iMaxTotalBytes = iTmpTotalBytes;
    }

    /* return图标 */
    atLayout[2].iTopLeftY  = atLayout[1].iBotRightY + iHeight / 2 + 1;
    atLayout[2].iBotRightY = atLayout[2].iTopLeftY + iHeight - 1;
    atLayout[2].iTopLeftX  = (iXres - iWidth) / 2;
    atLayout[2].iBotRightX = atLayout[2].iTopLeftX + iWidth - 1;

    iTmpTotalBytes = (atLayout[2].iBotRightX - atLayout[2].iTopLeftX + 1) * (atLayout[2].iBotRightY - atLayout[2].iTopLeftY + 1) * iBpp / 8;
    if (ptPageLayout->iMaxTotalBytes < iTmpTotalBytes)
    {
        ptPageLayout->iMaxTotalBytes = iTmpTotalBytes;
    }

}


/**********************************************************************
 * 函数名称： ShowSettingPage
 * 功能描述： 显示"setting页面"
 * 输入参数： ptPageLayout - 内含多个图标的文件名和显示区域
 * 输出参数： 无
 * 返 回 值： 无
 * 修改日期        版本号     修改人          修改内容
 * -----------------------------------------------
 * 2013/02/08         V1.0      韦东山          创建
 ***********************************************************************/
static void ShowSettingPage(PT_PageLayout ptPageLayout)
{
    PT_VideoMem ptVideoMem;
    int iError;

    PT_Layout atLayout = ptPageLayout->atLayout;
        
    /* 1. 获得显存 */
    ptVideoMem = GetVideoMem(ID("setting"), 1);
    if (ptVideoMem == NULL)
    {
        DBG_PRINTF("can't get video mem for setting page!\n");
        return;
    }

    /* 2. 描画数据 */

    /* 如果还没有计算过各图标的坐标 */
    if (atLayout[0].iTopLeftX == 0)
    {
        CalcSettingPageLayout(ptPageLayout);
    }

    iError = GeneratePage(ptPageLayout, ptVideoMem);    

    /* 3. 刷到设备上去 */
    FlushVideoMemToDev(ptVideoMem);

    /* 4. 解放显存 */
    PutVideoMem(ptVideoMem);
}


/**********************************************************************
 * 函数名称： SettingPageGetInputEvent
 * 功能描述： 为"setting页面"获得输入数据,判断输入事件位于哪一个图标上
 * 输入参数： ptPageLayout - 内含多个图标的显示区域
 * 输出参数： ptInputEvent - 内含得到的输入数据
 * 返 回 值： -1     - 输入数据不位于任何一个图标之上
 *            其他值 - 输入数据所落在的图标(PageLayout->atLayout数组的哪一项)
 * 修改日期        版本号     修改人          修改内容
 * -----------------------------------------------
 * 2013/02/08         V1.0      韦东山          创建
 ***********************************************************************/
static int SettingPageGetInputEvent(PT_PageLayout ptPageLayout, PT_InputEvent ptInputEvent)
{
    return GenericGetInputEvent(ptPageLayout, ptInputEvent);
}


/**********************************************************************
 * 函数名称： SettingPageRun
 * 功能描述： "setting页面"的运行函数: 显示菜单图标,根据用户输入作出反应
 * 输入参数： ptParentPageParams - 未用
 * 输出参数： 无
 * 返 回 值： 无
 * 修改日期        版本号     修改人          修改内容
 * -----------------------------------------------
 * 2013/02/08         V1.0      韦东山          创建
 ***********************************************************************/
static void SettingPageRun(PT_PageParams ptParentPageParams)
{
    int iIndex;
    T_InputEvent tInputEvent;
    int bPressed = 0;
    int iIndexPressed = -1;
    T_PageParams tPageParams;

    tPageParams.iPageID = ID("setting");
    
    /* 1. 显示页面 */
    ShowSettingPage(&g_tSettingPageLayout);

    /* 2. 创建Prepare线程 */

    /* 3. 调用GetInputEvent获得输入事件，进而处理 */
    while (1)
    {
        iIndex = SettingPageGetInputEvent(&g_tSettingPageLayout, &tInputEvent);
        if (tInputEvent.iPressure == 0)
        {
            /* 如果是松开 */
            if (bPressed)
            {
                /* 曾经有按钮被按下 */
                ReleaseButton(&g_atSettingPageIconsLayout[iIndexPressed]);
                bPressed = 0;

                if (iIndexPressed == iIndex) /* 按下和松开都是同一个按钮 */
                {
                    switch (iIndexPressed)
                    {
                        case 0: /* "选择目录"按钮 */
                        {
                            /* browse页面的Run参数含义: 
                             * 0 - 用于观看图片
                             * 1 - 用于浏览/选择文件夹, 点击文件无反应 
                             */
                            Page("browse")->Run(&tPageParams);
                            ShowSettingPage(&g_tSettingPageLayout);
                            break;
                        }
                        case 1: /* interval按钮 */
                        {
                            Page("interval")->Run(&tPageParams);
                            ShowSettingPage(&g_tSettingPageLayout);
                            break;
                        }
                        case 2: /* 返回按钮 */
                        {
                            return;
                        }
                        default:
                        {
                            break;
                        }
                    }
                }

                iIndexPressed = -1;
            }
        }
        else
        {
            /* 按下状态 */
            if (iIndex != -1)
            {
                if (!bPressed)
                {
                    /* 未曾按下按钮 */
                    bPressed = 1;
                    iIndexPressed = iIndex;
                    PressButton(&g_atSettingPageIconsLayout[iIndexPressed]);
                }
            }
        }        
    }    
}

static T_PageAction g_tSettingPageAction = {
    .name          = "setting",
    .Run           = SettingPageRun,
    .GetInputEvent = SettingPageGetInputEvent,
    //.Prepare       = MainPagePrepare;
};


/**********************************************************************
 * 函数名称： SettingPageInit
 * 功能描述： 注册"setting页面"
 * 输入参数： 无
 * 输出参数： 无
 * 返 回 值： 0 - 成功, 其他值 - 失败
 * 修改日期        版本号     修改人          修改内容
 * -----------------------------------------------
 * 2013/02/08         V1.0      韦东山          创建
 ***********************************************************************/
int SettingPageInit(void)
{
    return RegisterPageAction(&g_tSettingPageAction);
}

